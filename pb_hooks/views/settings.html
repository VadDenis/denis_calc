{{define "title"}}Настройки{{end}}

{{define "body"}}
<h1>Настройки</h1>

<div x-data="{
  items: [],
  showAddForm: false,
  showEditForm: false,
  currentItem: null,
  formData: {
    name: ''
  },

  async loadItems() {
    try {
      const response = await fetch('/api/collections/filter_cleaning_class/records');
      const data = await response.json();
      this.items = data.items;
    } catch (err) {
      alert('Ошибка загрузки данных');
    }
  },

  async addItem() {
    try {
      const response = await fetch('/api/collections/filter_cleaning_class/records', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(this.formData)
      });
      
      if (response.ok) {
        this.showAddForm = false;
        this.formData.name = '';
        await this.loadItems();
      }
    } catch (err) {
      alert('Ошибка при создании');
    }
  },

  editItem(item) {
    this.currentItem = item;
    this.formData.name = item.name;
    this.showEditForm = true;
  },

  async updateItem() {
    try {
      const response = await fetch(`/api/collections/filter_cleaning_class/records/${this.currentItem.id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(this.formData)
      });

      if (response.ok) {
        this.showEditForm = false;
        this.currentItem = null;
        this.formData.name = '';
        await this.loadItems();
      }
    } catch (err) {
      alert('Ошибка при обновлении');
    }
  },

  async deleteItem(id) {
    if (!confirm('Удалить запись?')) return;
    
    try {
      const response = await fetch(`/api/collections/filter_cleaning_class/records/${id}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        await this.loadItems();
      }
    } catch (err) {
      alert('Ошибка при удалении');
    }
  }
}" x-init="loadItems">

  <!-- Таблица данных -->
  <table role="grid">
    <thead>
      <tr>
        <th>ID</th>
        <th>Название</th>
        <th>Создано</th>
        <th>Обновлено</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody>
      <template x-for="item in items" :key="item.id">
        <tr>
          <td x-text="item.id"></td>
          <td x-text="item.name"></td>
          <td x-text="new Date(item.created).toLocaleString()"></td>
          <td x-text="new Date(item.updated).toLocaleString()"></td>
          <td>
            <button class="outline" @click="editItem(item)">Изменить</button>
            <button class="outline secondary" @click="deleteItem(item.id)">Удалить</button>
          </td>
        </tr>
      </template>
    </tbody>
  </table>

  <button class="primary" @click="showAddForm = true">Добавить запись</button>

  <!-- Модальное окно добавления -->
  <dialog :open="showAddForm">
    <article>
      <header>
        <h3>Добавить запись</h3>
      </header>
      <form @submit.prevent="addItem">
        <label>
          Название
          <input type="text" x-model="formData.name" required>
        </label>
        <footer style="display: flex; flex-direction: column; gap: 0.5rem;">
          <button type="submit" style="width: 100%;">Добавить</button>
          <button type="button" class="secondary" @click="showAddForm = false" style="width: 100%;">Отмена</button>
        </footer>
      </form>
    </article>
  </dialog>

  <!-- Модальное окно редактирования -->
  <dialog :open="showEditForm">
    <article>
      <header>
        <h3>Редактировать запись</h3>
      </header>
      <form @submit.prevent="updateItem">
        <label>
          Название
          <input type="text" x-model="formData.name" required>
        </label>
        <footer style="display: flex; flex-direction: column; gap: 0.5rem;">
          <button type="submit" style="width: 100%;">Изменить</button>
          <button type="button" class="secondary" @click="showEditForm = false" style="width: 100%;">Отмена</button>
        </footer>
      </form>
    </article>
  </dialog>

</div>
{{end}}