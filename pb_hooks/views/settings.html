{{define "title"}}ЭЛВЕНТ: Справочники{{end}}

{{define "body"}}
<h1>Справочники</h1>

<!-- Обновляем основной контейнер -->
<div x-data="{
  activeTable: new URLSearchParams(window.location.search).get('tab') || 'filters',
  items: [],
  showAddForm: false,
  showEditForm: false,
  formData: { name: '' },
  editData: { id: null, name: '' },

  async loadItems() {
    try {
      this.items = [];
      const collection = this.activeTable === 'cleaning' ? 'filter_cleaning_class' :
                        this.activeTable === 'types' ? 'filter_type' :
                        this.activeTable === 'materials' ? 'materials' :
                        this.activeTable === 'third_party' ? 'third_party_products' : 'filters';
      const response = await fetch(`/api/collections/${collection}/records`);
      const data = await response.json();
      this.items = data.items;
    } catch (err) {
      console.error('Ошибка загрузки:', err);
      alert('Ошибка при загрузке данных');
    }
  },

  async switchTab(tabName) {
    this.activeTable = tabName;
    this.showAddForm = false;
    this.showEditForm = false;
    this.formData.name = '';
    this.editData = { id: null, name: '' };
    
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    history.pushState({}, '', url);
    
    await this.loadItems();
  },

  async addItem() {
    try {
      const collection = this.activeTable === 'cleaning' ? 'filter_cleaning_class' :
                        this.activeTable === 'types' ? 'filter_type' :
                        this.activeTable === 'materials' ? 'materials' :
                        this.activeTable === 'third_party' ? 'third_party_products' : 'filters';
      
      if (!this.formData.name) {
        throw new Error('Название не может быть пустым');
      }

      const response = await fetch(`/api/collections/${collection}/records`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: this.formData.name })
      });

      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

      // Очищаем форму и закрываем модальное окно
      this.showAddForm = false;
      this.formData.name = '';
      
      // Обновляем данные в таблице
      await this.loadItems();
    } catch (err) {
      console.error('Ошибка добавления:', err);
      alert('Ошибка при добавлении записи');
    }
  },

  editItem(item) {
    try {
      // Обновляем данные для редактирования
      this.editData = {
        id: item.id,
        name: item.name
      };
      // Показываем форму
      this.showEditForm = true;
    } catch (err) {
      console.error('Ошибка при открытии формы редактирования:', err);
      alert('Ошибка при открытии формы редактирования');
    }
  },

  async updateItem() {
    try {
      // Определяем коллекцию
      const collection = this.activeTable === 'cleaning' ? 'filter_cleaning_class' :
                        this.activeTable === 'types' ? 'filter_type' :
                        this.activeTable === 'materials' ? 'materials' :
                        this.activeTable === 'third_party' ? 'third_party_products' : 'filters';
      
      if (!this.editData.id || !this.editData.name) {
        throw new Error('Некорректные данные для обновления');
      }

      const response = await fetch(`/api/collections/${collection}/records/${this.editData.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: this.editData.name })
      });

      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

      // Закрываем форму и очищаем данные
      this.showEditForm = false;
      this.editData = { id: null, name: '' };
      
      // Обновляем данные в таблице
      await this.loadItems();
    } catch (err) {
      console.error('Ошибка обновления:', err);
      alert('Ошибка при обновлении записи');
    }
  },

  async deleteItem(id) {
    if (!confirm('Удалить запись?')) return;
    
    try {
      const collection = this.activeTable === 'cleaning' ? 'filter_cleaning_class' :
                        this.activeTable === 'types' ? 'filter_type' :
                        this.activeTable === 'materials' ? 'materials' :
                        this.activeTable === 'third_party' ? 'third_party_products' : 'filters';
      
      const response = await fetch(`/api/collections/${collection}/records/${id}`, {
        method: 'DELETE'
      });

      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

      await this.loadItems();
    } catch (err) {
      console.error('Ошибка удаления:', err);
      alert('Ошибка при удалении записи');
    }
  }
}" x-init="loadItems">

  <!-- Обновляем навигационное меню -->
  <div class="tabs" style="margin-bottom: 2rem;">
    <button 
      :class="{ 'active': activeTable === 'filters' }"
      @click="switchTab('filters')"
    >
      Готовые фильтры
    </button>
    <button 
      :class="{ 'active': activeTable === 'cleaning' }"
      @click="switchTab('cleaning')"
    >
      Класс очистки
    </button>
    <button 
      :class="{ 'active': activeTable === 'types' }"
      @click="switchTab('types')"
    >
      Типы фильтров
    </button>
    <button 
      :class="{ 'active': activeTable === 'materials' }"
      @click="switchTab('materials')"
    >
      Материалы для производства
    </button>
    <button 
      :class="{ 'active': activeTable === 'third_party' }"
      @click="switchTab('third_party')"
    >
      Сторонняя продукция
    </button>
  </div>

  <!-- Таблица классов очистки -->
  <div x-show="activeTable === 'cleaning'">
    <h2>Класс очистки</h2>

    <!-- Таблица данных класса очистки -->
    <table role="grid">
      <thead>
        <tr>
          <th>ID</th>
          <th>Класс очистки</th>
          <th>Создано</th>
          <th>Обновлено</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="item in items" :key="item.id">
          <tr>
            <td x-text="item.id"></td>
            <td x-text="item.name"></td>
            <td x-text="new Date(item.created).toLocaleString()"></td>
            <td x-text="new Date(item.updated).toLocaleString()"></td>
            <td>
              <button class="outline" @click="editItem(item)">Изменить</button>
              <button class="outline secondary" @click="deleteItem(item.id)">Удалить</button>
            </td>
          </tr>
        </template>
      </tbody>
    </table>

    <button class="primary" @click="showAddForm = true" x-text="'Добавить ' + (
      activeTable === 'cleaning' ? 'класс очистки' :
      activeTable === 'types' ? 'тип фильтра' :
      activeTable === 'materials' ? 'материал' :
      activeTable === 'third_party' ? 'стороннюю продукцию' : 'фильтр'
    )"></button>

  </div>

  <!-- Таблица типов фильтров -->
  <div x-show="activeTable === 'types'">
    <div x-data="{
      items: [],
      showAddForm: false,
      showEditForm: false,
      formData: {
        name: ''
      },
      editData: {
        id: null,
        name: ''
      },
      
      async loadItems() {
        const response = await fetch('/api/collections/filter_type/records');
        const data = await response.json();
        this.items = data.items;
      },

      async addItem() {
        await fetch('/api/collections/filter_type/records', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(this.formData)
        });
        this.showAddForm = false;
        this.formData.name = '';
        await this.loadItems();
      },

      async deleteItem(id) {
        if (confirm('Удалить запись?')) {
          await fetch(`/api/collections/filter_type/records/${id}`, {
            method: 'DELETE'
          });
          await this.loadItems();
        }
      },

      editItem(item) {
        this.editData.id = item.id;
        this.editData.name = item.name;
        this.showEditForm = true;
      },

      async updateItem() {
        await fetch(`/api/collections/filter_type/records/${this.editData.id}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: this.editData.name
          })
        });
        this.showEditForm = false;
        this.editData = { id: null, name: '' };
        await this.loadItems();
      }
    }" x-init="loadItems">

      <h2>Типы фильтров</h2>
      
      <table>
        <thead>
          <tr>
            <th>Название</th>
            <th>Создано</th>
            <th>Обновлено</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="item in items">
            <tr>
              <td x-text="item.name"></td>
              <td x-text="new Date(item.created).toLocaleString()"></td>
              <td x-text="new Date(item.updated).toLocaleString()"></td>
              <td>
                <button class="outline" @click="editItem(item)">Изменить</button>
                <button class="outline secondary" @click="deleteItem(item.id)">Удалить</button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>

      <button class="primary" @click="showAddForm = true" x-text="'Добавить ' + (
        activeTable === 'cleaning' ? 'класс очистки' :
        activeTable === 'types' ? 'тип фильтра' :
        activeTable === 'materials' ? 'материал' :
        activeTable === 'third_party' ? 'стороннюю продукцию' : 'фильтр'
      )"></button>

    </div>
  </div>

  <!-- Добавляем секцию для материалов -->
  <div x-show="activeTable === 'materials'">
    <h2>Материалы для производства</h2>

    <!-- Таблица данных материалов -->
    <table role="grid">
        <thead>
            <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Создано</th>
                <th>Обновлено</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            <template x-for="item in items">
                <tr>
                    <td x-text="item.id"></td>
                    <td x-text="item.name"></td>
                    <td x-text="new Date(item.created).toLocaleString()"></td>
                    <td x-text="new Date(item.updated).toLocaleString()"></td>
                    <td>
                        <button class="outline" @click="editItem(item)">Изменить</button>
                        <button class="outline secondary" @click="deleteItem(item.id)">Удалить</button>
                    </td>
                </tr>
            </template>
        </tbody>
    </table>

    <button class="primary" @click="showAddForm = true" x-text="'Добавить ' + (
      activeTable === 'cleaning' ? 'класс очистки' :
      activeTable === 'types' ? 'тип фильтра' :
      activeTable === 'materials' ? 'материал' :
      activeTable === 'third_party' ? 'стороннюю продукцию' : 'фильтр'
    )"></button>

  </div>

  <!-- Добавляем таблицу фильтров -->
  <div x-show="activeTable === 'filters'">
    <h2>Готовые фильтры</h2>
    
    <table role="grid">
      <thead>
        <tr>
          <th>Название</th>
          <th>Создано</th>
          <th>Обновлено</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="item in items">
          <tr>
            <td x-text="item.name"></td>
            <td x-text="new Date(item.created).toLocaleString()"></td>
            <td x-text="new Date(item.updated).toLocaleString()"></td>
            <td>
              <button class="outline" @click="editItem(item)">Изменить</button>
              <button class="outline secondary" @click="deleteItem(item.id)">Удалить</button>
            </td>
          </tr>
        </template>
      </tbody>
    </table>
  
    <button class="primary" @click="showAddForm = true" x-text="'Добавить ' + (
      activeTable === 'cleaning' ? 'класс очистки' :
      activeTable === 'types' ? 'тип фильтра' :
      activeTable === 'materials' ? 'материал' :
      activeTable === 'third_party' ? 'стороннюю продукцию' : 'фильтр'
    )"></button>

  </div>

  <!-- Добавляем таблицу сторонней продукции -->
  <div x-show="activeTable === 'third_party'">
    <h2>Сторонняя продукция</h2>
    
    <table role="grid">
      <thead>
        <tr>
          <th>Название</th>
          <th>Создано</th>
          <th>Обновлено</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="item in items" :key="item.id">
          <tr>
            <td x-text="item.name"></td>
            <td x-text="new Date(item.created).toLocaleString()"></td>
            <td x-text="new Date(item.updated).toLocaleString()"></td>
            <td>
              <button class="outline" @click="editItem(item)">Изменить</button>
              <button class="outline secondary" @click="deleteItem(item.id)">Удалить</button>
            </td>
          </tr>
        </template>
      </tbody>
    </table>

    <button class="primary" @click="showAddForm = true" x-text="'Добавить ' + (
      activeTable === 'cleaning' ? 'класс очистки' :
      activeTable === 'types' ? 'тип фильтра' :
      activeTable === 'materials' ? 'материал' :
      activeTable === 'third_party' ? 'стороннюю продукцию' : 'фильтр'
    )"></button>
  </div>

  <!-- Унифицированное модальное окно редактирования -->
  <dialog :open="showEditForm">
    <article>
      <header>
        <h3 x-text="'Изменить ' + (
          activeTable === 'cleaning' ? 'класс очистки' :
          activeTable === 'types' ? 'тип фильтра' :
          activeTable === 'materials' ? 'материал' :
          activeTable === 'third_party' ? 'стороннюю продукцию' : 'фильтр'
        )"></h3>
      </header>
      <form @submit.prevent="updateItem">
        <label>
          Название
          <input type="text" x-model="editData.name" required>
        </label>
        <footer style="display: flex; flex-direction: column; gap: 0.5rem;">
          <button type="submit" style="width: 100%;">Сохранить</button>
          <button type="button" class="secondary" @click="showEditForm = false" style="width: 100%;">Отмена</button>
        </footer>
      </form>
    </article>
  </dialog>

  <!-- Унифицированное модальное окно добавления -->
  <dialog :open="showAddForm">
    <article>
      <header>
        <h3 x-text="'Добавить ' + (
          activeTable === 'cleaning' ? 'класс очистки' :
          activeTable === 'types' ? 'тип фильтра' :
          activeTable === 'materials' ? 'материал' :
          activeTable === 'third_party' ? 'стороннюю продукцию' : 'фильтр'
        )"></h3>
      </header>
      <form @submit.prevent="addItem">
        <label>
          Название
          <input type="text" x-model="formData.name" required>
        </label>
        <footer style="display: flex; flex-direction: column; gap: 0.5rem;">
          <button type="submit" style="width: 100%;">Добавить</button>
          <button type="button" class="secondary" @click="showAddForm = false" style="width: 100%;">Отмена</button>
        </footer>
      </form>
    </article>
  </dialog>

</div>

<style>
.tabs {
  display: flex;
  gap: 1rem;
}

.tabs button {
  padding: 0.5rem 1rem;
  border: none;
  background: none;
  cursor: pointer;
}

.tabs button.active {
  border-bottom: 2px solid var(--primary);
  font-weight: bold;
}
</style>

{{end}}