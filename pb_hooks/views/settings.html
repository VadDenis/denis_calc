{{define "title"}}ЭЛВЕНТ: Справочники{{end}}

{{define "body"}}
<h1>Справочники</h1>

<!-- Добавляем общий контейнер с состоянием activeTable -->
<div x-data="{
  activeTable: new URLSearchParams(window.location.search).get('tab') || 'cleaning',
  items: [],
  showAddForm: false,
  showEditForm: false,
  currentItem: null,
  formData: {
    name: ''
  },
  editData: {
    id: null,
    name: ''
  },

  async loadItems() {
    try {
      // Очищаем старые данные
      this.items = [];
      
      const collection = this.activeTable === 'cleaning' ? 'filter_cleaning_class' :
                        this.activeTable === 'types' ? 'filter_type' : 'materials';
      const response = await fetch(`/api/collections/${collection}/records`);
      const data = await response.json();
      this.items = data.items;
    } catch (err) {
      alert('Ошибка загрузки данных');
    }
  },

  async addItem() {
    try {
      const collection = this.activeTable === 'cleaning' ? 'filter_cleaning_class' :
                        this.activeTable === 'types' ? 'filter_type' : 'materials';
      
      const response = await fetch(`/api/collections/${collection}/records`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: this.formData.name
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      
      if (result.id) {
        // Очищаем форму
        this.showAddForm = false;
        this.formData.name = '';
        // Перезагружаем данные
        await this.loadItems();
      } else {
        throw new Error('Не удалось добавить запись');
      }
    } catch (err) {
      console.error('Ошибка при добавлении:', err);
      alert('Ошибка при добавлении записи');
    }
  },

  editItem(item) {
    try {
      // Сохраняем данные для редактирования
      this.editData = {
        id: item.id,
        name: item.name
      };
      // Показываем форму редактирования
      this.showEditForm = true;
    } catch (err) {
      console.error('Ошибка при открытии формы редактирования:', err);
      alert('Ошибка при открытии формы редактирования');
    }
  },

  async updateItem() {
    try {
      // Определяем нужную коллекцию
      const collection = this.activeTable === 'cleaning' ? 'filter_cleaning_class' :
                        this.activeTable === 'types' ? 'filter_type' : 'materials';
      
      const response = await fetch(`/api/collections/${collection}/records/${this.editData.id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: this.editData.name
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      // Закрываем форму и очищаем данные
      this.showEditForm = false;
      this.editData = { id: null, name: '' };
      
      // Перезагружаем данные таблицы
      await this.loadItems();
    } catch (err) {
      console.error('Ошибка при обновлении:', err);
      alert('Ошибка при обновлении записи');
    }
  },

  async deleteItem(id) {
    if (!confirm('Удалить запись?')) return;
    
    try {
      const collection = this.activeTable === 'cleaning' ? 'filter_cleaning_class' :
                        this.activeTable === 'types' ? 'filter_type' : 'materials';
      
      const response = await fetch(`/api/collections/${collection}/records/${id}`, {
        method: 'DELETE'
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      await this.loadItems();
    } catch (err) {
      console.error('Ошибка при удалении:', err);
      alert('Ошибка при удалении записи');
    }
  },

  async switchTab(tabName) {
    this.activeTable = tabName;
    // Очищаем формы при переключении
    this.showAddForm = false;
    this.showEditForm = false;
    this.formData.name = '';
    this.editData = { id: null, name: '' };
    
    // Обновляем URL
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    history.pushState({}, '', url);
    
    // Загружаем данные для нового таба
    await this.loadItems();
  }
}" x-init="loadItems">

  <!-- Обновляем навигационное меню -->
  <div class="tabs" style="margin-bottom: 2rem;">
    <button 
      :class="{ 'active': activeTable === 'cleaning' }"
      @click="switchTab('cleaning')"
    >
      Классы очистки
    </button>
    <button 
      :class="{ 'active': activeTable === 'types' }"
      @click="switchTab('types')"
    >
      Типы фильтров
    </button>
    <button 
      :class="{ 'active': activeTable === 'materials' }"
      @click="switchTab('materials')"
    >
      Материалы
    </button>
  </div>

  <!-- Таблица классов очистки -->
  <div x-show="activeTable === 'cleaning'">
    <h2>Класс очистки</h2>

    <!-- Таблица данных класса очистки -->
    <table role="grid">
      <thead>
        <tr>
          <th>ID</th>
          <th>Класс очистки</th>
          <th>Создано</th>
          <th>Обновлено</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="item in items" :key="item.id">
          <tr>
            <td x-text="item.id"></td>
            <td x-text="item.name"></td>
            <td x-text="new Date(item.created).toLocaleString()"></td>
            <td x-text="new Date(item.updated).toLocaleString()"></td>
            <td>
              <button class="outline" @click="editItem(item)">Изменить</button>
              <button class="outline secondary" @click="deleteItem(item.id)">Удалить</button>
            </td>
          </tr>
        </template>
      </tbody>
    </table>

    <button class="primary" @click="showAddForm = true">Добавить класс очистки</button>

    <!-- Модальное окно добавления класса очистки -->
    <dialog :open="showAddForm">
      <article>
        <header>
          <h3>Добавление класса очистки</h3>
        </header>
        <form @submit.prevent="addItem">
          <label>
            класс очистки
            <input type="text" x-model="formData.name" required>
          </label>
          <footer style="display: flex; flex-direction: column; gap: 0.5rem;">
            <button type="submit" style="width: 100%;">Добавить</button>
            <button type="button" class="secondary" @click="showAddForm = false" style="width: 100%;">Отмена</button>
          </footer>
        </form>
      </article>
    </dialog>

    <!-- Модальное окно редактирования класса очистки -->
    <dialog :open="showEditForm">
      <article>
        <header>
          <h3>Редактирование класса очистки</h3>
        </header>
        <form @submit.prevent="updateItem">
          <label>
            Класс очистки
            <input type="text" x-model="formData.name" required>
          </label>
          <footer style="display: flex; flex-direction: column; gap: 0.5rem;">
            <button type="submit" style="width: 100%;">Изменить</button>
            <button type="button" class="secondary" @click="showEditForm = false" style="width: 100%;">Отмена</button>
          </footer>
        </form>
      </article>
    </dialog>
  </div>

  <!-- Таблица типов фильтров -->
  <div x-show="activeTable === 'types'">
    <div x-data="{
      items: [],
      showAddForm: false,
      showEditForm: false,
      formData: {
        name: ''
      },
      editData: {
        id: null,
        name: ''
      },
      
      async loadItems() {
        const response = await fetch('/api/collections/filter_type/records');
        const data = await response.json();
        this.items = data.items;
      },

      async addItem() {
        await fetch('/api/collections/filter_type/records', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(this.formData)
        });
        this.showAddForm = false;
        this.formData.name = '';
        await this.loadItems();
      },

      async deleteItem(id) {
        if (confirm('Удалить запись?')) {
          await fetch(`/api/collections/filter_type/records/${id}`, {
            method: 'DELETE'
          });
          await this.loadItems();
        }
      },

      editItem(item) {
        this.editData.id = item.id;
        this.editData.name = item.name;
        this.showEditForm = true;
      },

      async updateItem() {
        await fetch(`/api/collections/filter_type/records/${this.editData.id}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: this.editData.name
          })
        });
        this.showEditForm = false;
        this.editData = { id: null, name: '' };
        await this.loadItems();
      }
    }" x-init="loadItems">

      <h2>Типы фильтров</h2>
      
      <table>
        <thead>
          <tr>
            <th>Название</th>
            <th>Создано</th>
            <th>Обновлено</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="item in items">
            <tr>
              <td x-text="item.name"></td>
              <td x-text="new Date(item.created).toLocaleString()"></td>
              <td x-text="new Date(item.updated).toLocaleString()"></td>
              <td>
                <button class="outline" @click="editItem(item)">Изменить</button>
                <button class="outline secondary" @click="deleteItem(item.id)">Удалить</button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>

      <button class="primary" @click="showAddForm = true">Добавить тип фильтра</button>

      <!-- Модальное окно добавления типа фильтров -->
      <dialog :open="showAddForm">
        <article>
          <header>
            <h3>Добавить тип фильтра</h3>
          </header>
          <form @submit.prevent="addItem">
            <label>
              Тип фильтра
              <input type="text" x-model="formData.name" required>
            </label>
            <footer style="display: flex; flex-direction: column; gap: 0.5rem;">
              <button type="submit" style="width: 100%;">Добавить</button>
              <button type="button" class="secondary" @click="showAddForm = false" style="width: 100%;">Отмена</button>
            </footer>
          </form>
        </article>
      </dialog>

      <!-- Модальное окно редактирования типа фильтра -->
      <dialog :open="showEditForm">
        <article>
          <header>
            <h3>Изменения типа фильтра</h3>
          </header>
          <form @submit.prevent="updateItem">
            <label>
              Тип фильтра
              <input type="text" x-model="editData.name" required>
            </label>
            <footer style="display: flex; flex-direction: column; gap: 0.5rem;">
              <button type="submit" style="width: 100%;">Изменить</button>
              <button type="button" class="secondary" @click="showEditForm = false" style="width: 100%;">Отмена</button>
            </footer>
          </form>
        </article>
      </dialog>
    </div>
  </div>

  <!-- Добавляем секцию для материалов -->
  <div x-show="activeTable === 'materials'">
    <h2>Материалы</h2>

    <!-- Таблица данных материалов -->
    <table role="grid">
        <thead>
            <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Создано</th>
                <th>Обновлено</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            <template x-for="item in items">
                <tr>
                    <td x-text="item.id"></td>
                    <td x-text="item.name"></td>
                    <td x-text="new Date(item.created).toLocaleString()"></td>
                    <td x-text="new Date(item.updated).toLocaleString()"></td>
                    <td>
                        <button class="outline" @click="editItem(item)">Изменить</button>
                        <button class="outline secondary" @click="deleteItem(item.id)">Удалить</button>
                    </td>
                </tr>
            </template>
        </tbody>
    </table>

    <button class="primary" @click="showAddForm = true">Добавить материал</button>

    <!-- Модальное окно добавления материала -->
    <dialog :open="showAddForm">
        <article>
            <header>
                <h3>Добавить материал</h3>
            </header>
            <form @submit.prevent="addItem">
                <label>
                    Название
                    <input type="text" x-model="formData.name" required>
                </label>
                <footer style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <button type="submit" style="width: 100%;">Добавить</button>
                    <button type="button" class="secondary" @click="showAddForm = false" style="width: 100%;">Отмена</button>
                </footer>
            </form>
        </article>
    </dialog>

    <!-- Модальное окно редактирования материала -->
    <dialog :open="showEditForm">
        <article>
            <header>
                <h3>Изменить материал</h3>
            </header>
            <form @submit.prevent="updateItem">
                <label>
                    Название
                    <input type="text" x-model="editData.name" required>
                </label>
                <footer style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <button type="submit" style="width: 100%;">Сохранить</button>
                    <button type="button" class="secondary" @click="showEditForm = false" style="width: 100%;">Отмена</button>
                </footer>
            </form>
        </article>
    </dialog>
  </div>

</div>

<style>
.tabs {
  display: flex;
  gap: 1rem;
}

.tabs button {
  padding: 0.5rem 1rem;
  border: none;
  background: none;
  cursor: pointer;
}

.tabs button.active {
  border-bottom: 2px solid var(--primary);
  font-weight: bold;
}
</style>

{{end}}